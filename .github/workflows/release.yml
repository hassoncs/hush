name: CI & Release

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version calculation
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Build
        run: bun run build
      
      - name: Type check
        run: bun run type-check
      
      - name: Run tests
        run: bun run test

  release:
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Node.js (for npm publish)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Upgrade npm for trusted publishing
        run: npm install -g npm@latest
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Build
        run: bun run build
      
      - name: Calculate version bump
        id: version
        run: |
          # Get current npm version
          CURRENT_NPM_VERSION=$(npm view @chriscode/hush version 2>/dev/null || echo "0.0.0")
          echo "current_npm_version=$CURRENT_NPM_VERSION" >> $GITHUB_OUTPUT
          
          # Get current package.json version
          PACKAGE_VERSION=$(node -p "require('./hush-cli/package.json').version")
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          
          # Find the tag for the current npm version
          LAST_TAG="v$CURRENT_NPM_VERSION"
          
          # Check if tag exists, if not use all commits
          if git rev-parse "$LAST_TAG" >/dev/null 2>&1; then
            COMMITS=$(git log "$LAST_TAG"..HEAD --pretty=format:"%s" 2>/dev/null || echo "")
          else
            echo "No previous tag found, analyzing recent commits"
            COMMITS=$(git log --pretty=format:"%s" -50)
          fi
          
          echo "Commits since $LAST_TAG:"
          echo "$COMMITS"
          
          # Determine bump type from conventional commits
          BUMP="none"
          
          if echo "$COMMITS" | grep -qE "^[a-z]+(\(.+\))?!:"; then
            BUMP="major"
          elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
            BUMP="minor"
          elif echo "$COMMITS" | grep -qE "^(fix|docs|refactor|test|chore|style|ci|build)(\(.+\))?:"; then
            BUMP="patch"
          fi
          
          echo "bump=$BUMP" >> $GITHUB_OUTPUT
          
          if [ "$BUMP" = "none" ]; then
            echo "No conventional commits found, skipping release"
            echo "new_version=$CURRENT_NPM_VERSION" >> $GITHUB_OUTPUT
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            # Calculate new version
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_NPM_VERSION"
            
            case "$BUMP" in
              major)
                NEW_VERSION="$((MAJOR + 1)).0.0"
                ;;
              minor)
                NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
                ;;
              patch)
                NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
                ;;
            esac
            
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "Calculated new version: $NEW_VERSION ($BUMP bump)"
          fi
      
      - name: Check if version already published
        id: check_published
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          
          # Check if this version exists on npm
          if npm view "@chriscode/hush@$NEW_VERSION" version >/dev/null 2>&1; then
            echo "Version $NEW_VERSION already published, skipping"
            echo "already_published=true" >> $GITHUB_OUTPUT
          else
            echo "Version $NEW_VERSION not yet published"
            echo "already_published=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Update package.json version
        if: steps.version.outputs.should_release == 'true' && steps.check_published.outputs.already_published == 'false'
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          CURRENT_VERSION=$(node -p "require('./hush-cli/package.json').version")
          
          if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
            echo "package.json already at version $NEW_VERSION"
          else
            cd hush-cli
            # Use npm pkg set instead of npm version to avoid git hooks/issues
            npm pkg set version="$NEW_VERSION"
            echo "Updated package.json to version $NEW_VERSION"
          fi
      
      - name: Publish to npm (trusted publishing)
        if: steps.version.outputs.should_release == 'true' && steps.check_published.outputs.already_published == 'false'
        run: npm publish --access public --provenance
        working-directory: hush-cli
      
      - name: Create git tag
        if: steps.version.outputs.should_release == 'true' && steps.check_published.outputs.already_published == 'false'
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          TAG="v$NEW_VERSION"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit the version bump if there are changes
          git add hush-cli/package.json
          git commit -m "chore(release): $NEW_VERSION [skip ci]" || echo "No changes to commit"
          
          # Create tag
          git tag "$TAG" || echo "Tag already exists"
          
          # Push commit and tag separately to ensure tag is pushed
          git push origin main || echo "No commits to push"
          git push origin "$TAG"
          
          echo "Created and pushed tag $TAG"
      
      - name: Create GitHub Release
        if: steps.version.outputs.should_release == 'true' && steps.check_published.outputs.already_published == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          TAG="v$NEW_VERSION"
          
          # Generate release notes from commits
          LAST_TAG="v${{ steps.version.outputs.current_npm_version }}"
          
          if git rev-parse "$LAST_TAG" >/dev/null 2>&1; then
            NOTES=$(git log "$LAST_TAG"..HEAD~1 --pretty=format:"- %s" 2>/dev/null || echo "- Initial release")
          else
            NOTES="- Initial release"
          fi
          
          gh release create "$TAG" \
            --title "$TAG" \
            --notes "$NOTES" \
            --latest

  deploy-docs:
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install sops and age
        run: |
          curl -LO https://github.com/getsops/sops/releases/download/v3.9.4/sops-v3.9.4.linux.amd64
          sudo mv sops-v3.9.4.linux.amd64 /usr/local/bin/sops
          sudo chmod +x /usr/local/bin/sops
          
          curl -LO https://github.com/FiloSottile/age/releases/download/v1.2.0/age-v1.2.0-linux-amd64.tar.gz
          tar -xzf age-v1.2.0-linux-amd64.tar.gz
          sudo mv age/age /usr/local/bin/
          sudo mv age/age-keygen /usr/local/bin/
          sudo chmod +x /usr/local/bin/age /usr/local/bin/age-keygen
      
      - name: Setup age key
        run: |
          mkdir -p ~/.config/sops/age
          echo "${{ secrets.SOPS_AGE_KEY }}" > ~/.config/sops/age/key.txt
          chmod 600 ~/.config/sops/age/key.txt
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Build CLI and docs
        run: bun run build
      
      - name: Deploy docs with Hush secrets
        working-directory: docs
        run: |
          export SOPS_AGE_KEY_FILE=~/.config/sops/age/key.txt
          node ../hush-cli/bin/hush.js run -- bun run wrangler pages deploy ./dist --project-name=hush-docs
